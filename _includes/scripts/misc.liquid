{% if site.enable_tooltips %}
  <!-- Enable Tooltips -->
  <script type="text/javascript">
    $(function () {
      $('[data-bs-toggle="tooltip"]').tooltip();
    });
  </script>
{% endif %}
{% if site.enable_medium_zoom %}
  <!-- Medium Zoom JS -->
  <script
    defer
    src="{{ site.third_party_libraries.medium_zoom.url.js }}"
    integrity="{{ site.third_party_libraries.medium_zoom.integrity.js }}"
    crossorigin="anonymous"
  ></script>
  <script defer src="{{ '/assets/js/zoom.js' | relative_url | bust_file_cache }}"></script>
{% endif %}
{% if page.toc and page.toc.sidebar %}
  <!-- Sidebar Table of Contents -->
  <script defer src="{{ '/assets/js/bootstrap-toc.min.js' | relative_url | bust_file_cache }}"></script>
{% endif %}

<!-- Bootstrap Table -->
{% if page.pretty_table %}
  <!-- Bootstrap Table doesn't go well with diff2html -->
  <script
    defer
    src="{{ site.third_party_libraries.bootstrap-table.url.js }}"
    integrity="{{ site.third_party_libraries.bootstrap-table.integrity.js }}"
    crossorigin="anonymous"
  ></script>
{% endif %}

<!-- Load Common JS -->
<script src="{{ '/assets/js/no_defer.js' | relative_url | bust_file_cache }}"></script>
<script defer src="{{ '/assets/js/common.js' | relative_url | bust_file_cache }}"></script>
<script defer src="{{ '/assets/js/copy_code.js' | relative_url | bust_file_cache }}" type="text/javascript"></script>

<!-- Jupyter Open External Links New Tab -->
<script defer src="{{ '/assets/js/jupyter_new_tab.js' | relative_url | bust_file_cache }}"></script>

{% assign site.test-library.url = site.test-library.url | append: 'teste' %}

{% if site.enable_darkmode %}
  <!-- Mobile Theme Toggle Synchronization -->
  <script type="text/javascript">
    // Synchronize mobile theme toggle with main theme toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileToggle = document.getElementById('mobile-light-toggle');
      const desktopToggle = document.getElementById('light-toggle');
      
      if (mobileToggle && desktopToggle) {
        mobileToggle.addEventListener('click', function() {
          desktopToggle.click();
        });
      }
      
    });
  </script>
{% endif %}

<!-- Scroll-to-Hide Navbar -->
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;
    
    // Get progress bar elements
    const progressBar = document.getElementById('progress');
    const progressContainer = document.querySelector('.progress-container');
    
    // Debug: Log if elements are found
    console.log('Progress elements found:', { progressBar: !!progressBar, progressContainer: !!progressContainer });
    
    let lastScrollTop = 0;
    let scrollTimer = null;
    const scrollThreshold = 5; // Minimum scroll distance to trigger  
    const hideThreshold = 50; // Scroll distance to start hiding (reduced for testing)
    
    // Debug: Add more aggressive logging
    console.log('Scroll-to-hide initialized on page:', window.location.pathname);
    
    function handleScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollDelta = scrollTop - lastScrollTop;
      const documentHeight = document.documentElement.scrollHeight;
      const windowHeight = window.innerHeight;
      
      // Debug: Log scroll activity
      if (Math.abs(scrollDelta) > scrollThreshold) {
        console.log('Scroll detected:', { scrollTop, scrollDelta, hideThreshold, page: window.location.pathname });
      }
      
      // Add scrolled class for shadow effect
      if (scrollTop > 20) {
        navbar.classList.add('navbar-scrolled');
      } else {
        navbar.classList.remove('navbar-scrolled');
      }
      
      // Always show navbar when at the top or bottom
      if (scrollTop <= hideThreshold || (scrollTop + windowHeight >= documentHeight - 100)) {
        navbar.classList.remove('navbar-hidden');
        if (progressBar) {
          progressBar.classList.remove('progress-hidden');
          progressBar.style.transform = '';
          progressBar.style.opacity = '';
        }
        if (progressContainer) {
          progressContainer.classList.remove('progress-hidden');
          progressContainer.style.transform = '';
          progressContainer.style.opacity = '';
        }
        lastScrollTop = scrollTop;
        return;
      }
      
      // Only hide/show if we've scrolled enough and we're past the threshold
      if (Math.abs(scrollDelta) > scrollThreshold) {
        if (scrollDelta > 0) {
          // Scrolling down - hide navbar and progress bar
          navbar.classList.add('navbar-hidden');
          if (progressBar) {
            progressBar.classList.add('progress-hidden');
            progressBar.style.transform = 'translateY(-100%)';
            progressBar.style.opacity = '0';
          }
          if (progressContainer) {
            progressContainer.classList.add('progress-hidden');
            progressContainer.style.transform = 'translateY(-100%)';
            progressContainer.style.opacity = '0';
          }
        } else {
          // Scrolling up - show navbar and progress bar
          navbar.classList.remove('navbar-hidden');
          if (progressBar) {
            progressBar.classList.remove('progress-hidden');
            progressBar.style.transform = '';
            progressBar.style.opacity = '';
          }
          if (progressContainer) {
            progressContainer.classList.remove('progress-hidden');
            progressContainer.style.transform = '';
            progressContainer.style.opacity = '';
          }
        }
      }
      
      lastScrollTop = scrollTop;
    }
    
    // Throttle scroll events for better performance
    function throttledScroll() {
      if (scrollTimer) return;
      scrollTimer = setTimeout(function() {
        handleScroll();
        scrollTimer = null;
      }, 16); // ~60fps
    }
    
    // Add scroll listener
    window.addEventListener('scroll', throttledScroll, { passive: true });
    
    // Show navbar when hovering near the top of the screen
    document.addEventListener('mousemove', function(e) {
      if (e.clientY <= 100) {
        navbar.classList.remove('navbar-hidden');
        if (progressBar) {
          progressBar.classList.remove('progress-hidden');
          progressBar.style.transform = '';
          progressBar.style.opacity = '';
        }
        if (progressContainer) {
          progressContainer.classList.remove('progress-hidden');
          progressContainer.style.transform = '';
          progressContainer.style.opacity = '';
        }
      }
    });
    
    // Always show navbar when mobile menu is open  
    $(document).ready(function() {
      // Watch for drawer open/close
      const navbarCollapse = document.getElementById('navbarNav');
      if (navbarCollapse) {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
              if (navbarCollapse.classList.contains('drawer-open')) {
                navbar.classList.add('navbar-menu-open');
                navbar.classList.remove('navbar-hidden');
              } else {
                navbar.classList.remove('navbar-menu-open');
              }
            }
          });
        });
        observer.observe(navbarCollapse, { attributes: true });
      }
    });
  });
</script>

<!-- Mobile Drawer Navigation (Google Sites-style) -->
<script type="text/javascript">
  (function() {
    // Wait for DOM ready
    function initDrawer() {
      const navbarCollapse = document.getElementById('navbarNav');
      const navbarToggler = document.getElementById('navbar-drawer-toggle');
      
      if (!navbarCollapse || !navbarToggler) {
        console.log('Drawer: Missing elements', { navbarCollapse, navbarToggler });
        return;
      }
      
      // Prevent multiple initializations
      if (navbarCollapse.dataset.drawerInitialized === 'true') {
        console.log('Drawer: Already initialized, skipping');
        return;
      }
      navbarCollapse.dataset.drawerInitialized = 'true';
      
      console.log('Drawer: Initializing');
      
      // Create overlay element if not exists
      let overlay = document.getElementById('drawer-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'drawer-overlay';
        overlay.className = 'navbar-drawer-overlay';
        document.body.appendChild(overlay);
        console.log('Drawer: Created overlay');
      }
      
      // Create close button for drawer if not exists
      let closeBtn = navbarCollapse.querySelector('.drawer-close-btn');
      if (!closeBtn) {
        closeBtn = document.createElement('button');
        closeBtn.className = 'drawer-close-btn';
        closeBtn.setAttribute('aria-label', 'Close navigation menu');
        closeBtn.innerHTML = '<i class="ti ti-x"></i>';
        navbarCollapse.insertBefore(closeBtn, navbarCollapse.firstChild);
        console.log('Drawer: Created close button');
      }
      
      // Open drawer function
      function openDrawer() {
        console.log('Drawer: Opening');
        navbarCollapse.classList.add('drawer-open');
        overlay.classList.add('show');
        navbarToggler.classList.remove('collapsed');
        navbarToggler.setAttribute('aria-expanded', 'true');
        document.body.classList.add('drawer-is-open');
      }
      
      // Close drawer function
      function closeDrawer() {
        console.log('Drawer: Closing');
        navbarCollapse.classList.remove('drawer-open');
        overlay.classList.remove('show');
        navbarToggler.classList.add('collapsed');
        navbarToggler.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('drawer-is-open');
      }
      
      // Toggle drawer on hamburger click
      navbarToggler.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Drawer: Toggler clicked');
        if (navbarCollapse.classList.contains('drawer-open')) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });
      
      // Close drawer when clicking overlay
      overlay.addEventListener('click', function(e) {
        console.log('Drawer: Overlay clicked');
        closeDrawer();
      });
      
      // Close drawer when clicking close button
      closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Drawer: Close button clicked');
        closeDrawer();
      });
      
      // Close drawer when pressing Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && navbarCollapse.classList.contains('drawer-open')) {
          closeDrawer();
        }
      });
      
      // Handle nav link clicks - allow navigation, then close
      navbarCollapse.querySelectorAll('a.nav-link:not(.dropdown-toggle), a.dropdown-item').forEach(function(link) {
        link.addEventListener('click', function(e) {
          // Let the default action happen (navigation)
          // Close the drawer after a brief moment
          setTimeout(closeDrawer, 50);
        });
      });
      
      // Handle dropdown toggle clicks in drawer - toggle submenu
      navbarCollapse.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
          if (window.innerWidth < 992) {
            e.preventDefault();
            e.stopPropagation();
            const dropdown = this.closest('.dropdown');
            if (dropdown) {
              const isOpen = dropdown.classList.contains('show');
              // Close all other dropdowns first
              navbarCollapse.querySelectorAll('.dropdown.show').forEach(function(d) {
                d.classList.remove('show');
                d.querySelector('.dropdown-menu').style.display = 'none';
              });
              // Toggle this one
              if (!isOpen) {
                dropdown.classList.add('show');
                dropdown.querySelector('.dropdown-menu').style.display = 'block';
              }
            }
          }
        });
      });
      
      // Close drawer on window resize to desktop
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 992 && navbarCollapse.classList.contains('drawer-open')) {
          closeDrawer();
        }
      });
      
      console.log('Drawer: Initialization complete');
    }
    
    // Run on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDrawer);
    } else {
      initDrawer();
    }
  })();
</script>
